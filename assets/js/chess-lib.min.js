const realToBin=[32774,32768,32769,32770,32771,32772,32773,16385,16393,16392,16386,16402,16400,16387,16411,16408,16388,16420,16416,16389,16429,16424,16390,16438,16432,16391,16447,16440,20481,20489,20488,12289,12296,12290,12304,12291,12312,12292,12320,12293,12328,12294,12336,12295,12344,8201,8210,8219,8228,8237,8246,8255,4106,4113,16450,16458,16457,16456,16448,16451,16467,16465,16452,16476,16473,16453,16485,16481,16454,16494,16489,16455,16503,16497,16505,20546,20554,20553,20552,20544,12354,12361,12352,12355,12369,12356,12377,12357,12385,12358,12393,12359,12401,12409,8266,8264,8275,8284,8293,8302,8311,4171,4178,4176,16515,16523,16522,16521,16513,16516,16532,16530,16528,16512,16517,16541,16538,16518,16550,16546,16519,16559,16554,16562,16570,20611,20619,20618,20617,20609,12419,12426,12417,12420,12434,12416,12421,12442,12422,12450,12423,12458,12466,12474,8331,8329,8340,8336,8349,8358,8367,4236,4243,4241,4232,16580,16588,16587,16586,16578,16581,16597,16595,16593,16577,16582,16606,16603,16600,16576,16583,16615,16611,16619,16627,16635,20676,20684,20683,20682,20674,12484,12491,12482,12485,12499,12481,12486,12507,12480,12487,12515,12523,12531,12539,8396,8394,8405,8401,8414,8408,8423,4301,4308,4306,4297,16645,16653,16652,16651,16643,16646,16662,16660,16658,16642,16647,16671,16668,16665,16641,16676,16672,16640,16684,16692,16700,20741,20749,20748,20747,20739,12549,12556,12547,12550,12564,12546,12551,12572,12545,12580,12544,12588,12596,12604,8461,8459,8470,8466,8479,8473,8480,4366,4373,4371,4362,16710,16718,16717,16716,16708,16711,16727,16725,16723,16707,16733,16730,16706,16741,16737,16705,16749,16744,16704,16757,16765,20806,20814,20813,20812,20804,12614,12621,12612,12615,12629,12611,12637,12610,12645,12609,12653,12608,12661,12669,8526,8524,8535,8531,8538,8545,8552,4431,4438,4436,4427,16775,16783,16782,16781,16773,16790,16788,16772,16798,16795,16771,16806,16802,16770,16814,16809,16769,16822,16816,16768,16830,20871,20879,20878,20877,20869,12679,12686,12677,12694,12676,12702,12675,12710,12674,12718,12673,12726,12672,12734,8591,8589,8596,8603,8610,8617,8624,4503,4501,4492,16847,16846,16838,16855,16853,16837,16863,16860,16836,16871,16867,16835,16879,16874,16834,16887,16881,16833,16895,16888,16832,20943,20942,20934,12751,12742,12759,12741,12767,12740,12775,12739,12783,12738,12791,12737,12799,12736,8654,8661,8668,8675,8682,8689,8696,4566,4557,16905,16913,16912,16896,16897,16906,16922,16920,16907,16931,16928,16908,16940,16936,16909,16949,16944,16910,16958,16952,16911,21001,21009,21008,20992,20993,12809,12816,12800,12810,12824,12811,12832,12812,12840,12813,12848,12814,12856,12815,8721,8705,8730,8739,8748,8757,8766,4626,4633,4610,16970,16978,16977,16976,16968,16960,16961,16962,16971,16987,16985,16972,16996,16993,16973,17005,17001,16974,17014,17009,16975,17023,17017,21066,21074,21073,21072,21064,21056,21057,21058,12874,12881,12872,12865,12875,12889,12876,12897,12877,12905,12878,12913,12879,12921,8786,8784,8768,8770,8795,8804,8813,8822,8831,4691,4698,4696,4675,17035,17043,17042,17041,17033,17025,17026,17027,17036,17052,17050,17048,17032,17037,17061,17058,17038,17070,17066,17039,17079,17074,17082,21131,21139,21138,21137,21129,21121,21122,21123,12939,12946,12937,12930,12940,12954,12936,12941,12962,12942,12970,12943,12978,12986,8851,8849,8833,8835,8860,8856,8869,8878,8887,4756,4763,4761,4752,4736,4740,17100,17108,17107,17106,17098,17090,17091,17092,17101,17117,17115,17113,17097,17102,17126,17123,17120,17096,17103,17135,17131,17139,17147,21196,21204,21203,21202,21194,21186,21187,21188,13004,13011,13002,12995,13005,13019,13001,13006,13027,13e3,13007,13035,13043,13051,8916,8914,8898,8900,8925,8921,8934,8928,8943,4821,4828,4826,4817,4801,4805,17165,17173,17172,17171,17163,17155,17156,17157,17166,17182,17180,17178,17162,17167,17191,17188,17185,17161,17196,17192,17160,17204,17212,21261,21269,21268,21267,21259,21251,21252,21253,13069,13076,13067,13060,13070,13084,13066,13071,13092,13065,13100,13064,13108,13116,8981,8979,8963,8965,8990,8986,8999,8993,9e3,4886,4893,4891,4882,4866,4870,17230,17238,17237,17236,17228,17220,17221,17222,17231,17247,17245,17243,17227,17253,17250,17226,17261,17257,17225,17269,17264,17224,17277,21326,21334,21333,21332,21324,21316,21317,21318,13134,13141,13132,13125,13135,13149,13131,13157,13130,13165,13129,13173,13128,13181,9046,9044,9028,9030,9055,9051,9058,9065,9072,4951,4958,4956,4947,4931,4935,17295,17303,17302,17301,17293,17285,17286,17287,17310,17308,17292,17318,17315,17291,17326,17322,17290,17334,17329,17289,17342,17336,17288,21391,21399,21398,21397,21389,21381,21382,21383,13199,13206,13197,13190,13214,13196,13222,13195,13230,13194,13238,13193,13246,13192,9111,9109,9093,9095,9116,9123,9130,9137,9144,5023,5021,5012,4996,17367,17366,17358,17350,17351,17375,17373,17357,17383,17380,17356,17391,17387,17355,17399,17394,17354,17407,17401,17353,17352,21463,21462,21454,21446,21447,13271,13262,13255,13279,13261,13287,13260,13295,13259,13303,13258,13311,13257,13256,9174,9158,9181,9188,9195,9202,9209,5086,5077,5061,17425,17433,17432,17416,17417,17426,17442,17440,17408,17410,17427,17451,17448,17428,17460,17456,17429,17469,17464,17430,17431,21521,21529,21528,21512,21513,13329,13336,13320,13330,13344,13312,13331,13352,13332,13360,13333,13368,13334,13335,9241,9225,9250,9218,9259,9268,9277,5146,5153,5121,5130,17490,17498,17497,17496,17488,17480,17481,17482,17491,17507,17505,17473,17475,17492,17516,17513,17493,17525,17521,17494,17534,17529,17495,21586,21594,21593,21592,21584,21576,21577,21578,13394,13401,13392,13385,13395,13409,13377,13396,13417,13397,13425,13398,13433,13399,9306,9304,9288,9290,9315,9283,9324,9333,9342,5211,5218,5216,5184,5186,5195,17555,17563,17562,17561,17553,17545,17546,17547,17556,17572,17570,17568,17552,17536,17538,17540,17557,17581,17578,17558,17590,17586,17559,17599,17594,21651,21659,21658,21657,21649,21641,21642,21643,13459,13466,13457,13450,13460,13474,13456,13442,13461,13482,13462,13490,13463,13498,9371,9369,9353,9355,9380,9376,9344,9348,9389,9398,9407,5276,5283,5281,5272,5256,5249,5251,5260,17620,17628,17627,17626,17618,17610,17611,17612,17621,17637,17635,17633,17617,17601,17603,17605,17622,17646,17643,17640,17616,17623,17655,17651,17659,21716,21724,21723,21722,21714,21706,21707,21708,13524,13531,13522,13515,13525,13539,13521,13507,13526,13547,13520,13527,13555,13563,9436,9434,9418,9420,9445,9441,9409,9413,9454,9448,9463,5341,5348,5346,5337,5321,5314,5316,5325,17685,17693,17692,17691,17683,17675,17676,17677,17686,17702,17700,17698,17682,17666,17668,17670,17687,17711,17708,17705,17681,17716,17712,17680,17724,21781,21789,21788,21787,21779,21771,21772,21773,13589,13596,13587,13580,13590,13604,13586,13572,13591,13612,13585,13620,13584,13628,9501,9499,9483,9485,9510,9506,9474,9478,9519,9513,9520,5406,5413,5411,5402,5386,5379,5381,5390,17750,17758,17757,17756,17748,17740,17741,17742,17751,17767,17765,17763,17747,17731,17733,17735,17773,17770,17746,17781,17777,17745,17789,17784,17744,21846,21854,21853,21852,21844,21836,21837,21838,13654,13661,13652,13645,13655,13669,13651,13637,13677,13650,13685,13649,13693,13648,9566,9564,9548,9550,9575,9571,9539,9543,9578,9585,9592,5471,5478,5476,5467,5451,5444,5446,5455,17815,17823,17822,17821,17813,17805,17806,17807,17830,17828,17812,17796,17798,17838,17835,17811,17846,17842,17810,17854,17849,17809,17808,21911,21919,21918,21917,21909,21901,21902,21903,13719,13726,13717,13710,13734,13716,13702,13742,13715,13750,13714,13758,13713,13712,9631,9629,9613,9615,9636,9604,9643,9650,9657,5543,5541,5532,5516,5509,5511,17887,17886,17878,17870,17871,17895,17893,17877,17861,17863,17903,17900,17876,17911,17907,17875,17919,17914,17874,17873,17872,21983,21982,21974,21966,21967,13791,13782,13775,13799,13781,13767,13807,13780,13815,13779,13823,13778,13777,13776,9694,9678,9701,9669,9708,9715,9722,5606,5597,5581,5574,17945,17953,17952,17936,17937,17946,17962,17960,17928,17930,17947,17971,17968,17920,17923,17948,17980,17976,17949,17950,17951,22041,22049,22048,22032,22033,13849,13856,13840,13850,13864,13832,13851,13872,13824,13852,13880,13853,13854,13855,9761,9745,9770,9738,9779,9731,9788,5666,5673,5641,5650,18010,18018,18017,18016,18008,18e3,18001,18002,18011,18027,18025,17993,17995,18012,18036,18033,17985,17988,18013,18045,18041,18014,18015,22106,22114,22113,22112,22104,22096,22097,22098,13914,13921,13912,13905,13915,13929,13897,13916,13937,13889,13917,13945,13918,13919,9826,9824,9808,9810,9835,9803,9844,9796,9853,5731,5738,5736,5704,5706,5715,18075,18083,18082,18081,18073,18065,18066,18067,18076,18092,18090,18088,18072,18056,18058,18060,18077,18101,18098,18050,18053,18078,18110,18106,18079,22171,22179,22178,22177,22169,22161,22162,22163,13979,13986,13977,13970,13980,13994,13976,13962,13981,14002,13954,13982,14010,13983,9891,9889,9873,9875,9900,9896,9864,9868,9909,9861,9918,5796,5803,5801,5792,5776,5769,5771,5780,18140,18148,18147,18146,18138,18130,18131,18132,18141,18157,18155,18153,18137,18121,18123,18125,18142,18166,18163,18160,18136,18112,18115,18118,18143,18175,18171,22236,22244,22243,22242,22234,22226,22227,22228,14044,14051,14042,14035,14045,14059,14041,14027,14046,14067,14040,14019,14047,14075,9956,9954,9938,9940,9965,9961,9929,9933,9974,9968,9920,9926,9983,5861,5868,5866,5857,5841,5834,5836,5845,18205,18213,18212,18211,18203,18195,18196,18197,18206,18222,18220,18218,18202,18186,18188,18190,18207,18231,18228,18225,18201,18177,18180,18183,18236,18232,18200,22301,22309,22308,22307,22299,22291,22292,22293,14109,14116,14107,14100,14110,14124,14106,14092,14111,14132,14105,14084,14140,14104,10021,10019,10003,10005,10030,10026,9994,9998,10039,10033,9985,9991,10040,5926,5933,5931,5922,5906,5899,5901,5910,18270,18278,18277,18276,18268,18260,18261,18262,18271,18287,18285,18283,18267,18251,18253,18255,18293,18290,18266,18242,18245,18301,18297,18265,18264,22366,22374,22373,22372,22364,22356,22357,22358,14174,14181,14172,14165,14175,14189,14171,14157,14197,14170,14149,14205,14169,14168,10086,10084,10068,10070,10095,10091,10059,10063,10098,10050,10105,5991,5998,5996,5987,5971,5964,5966,5975,18335,18343,18342,18341,18333,18325,18326,18327,18350,18348,18332,18316,18318,18358,18355,18331,18307,18310,18366,18362,18330,18329,18328,22431,22439,22438,22437,22429,22421,22422,22423,14239,14246,14237,14230,14254,14236,14222,14262,14235,14214,14270,14234,14233,14232,10151,10149,10133,10135,10156,10124,10163,10115,10170,6063,6061,6052,6036,6029,6031,18407,18406,18398,18390,18391,18415,18413,18397,18381,18383,18423,18420,18396,18372,18375,18431,18427,18395,18394,18393,18392,22503,22502,22494,22486,22487,14311,14302,14295,14319,14301,14287,14327,14300,14279,14335,14299,14298,14297,14296,10214,10198,10221,10189,10228,10180,10235,6126,6117,6101,6094,18465,18473,18472,18456,18457,18466,18482,18480,18448,18450,18467,18491,18488,18440,18443,18468,18432,18436,18469,18470,18471,22561,22569,22568,22552,22553,14369,14376,14360,14370,14384,14352,14371,14392,14344,14372,14336,14373,14374,14375,10281,10265,10290,10258,10299,10251,10244,6186,6193,6161,6170,18530,18538,18537,18536,18528,18520,18521,18522,18531,18547,18545,18513,18515,18532,18556,18553,18505,18508,18533,18497,18501,18534,18535,22626,22634,22633,22632,22624,22616,22617,22618,14434,14441,14432,14425,14435,14449,14417,14436,14457,14409,14437,14401,14438,14439,10346,10344,10328,10330,10355,10323,10364,10316,10309,6251,6258,6256,6224,6226,6235,18595,18603,18602,18601,18593,18585,18586,18587,18596,18612,18610,18608,18592,18576,18578,18580,18597,18621,18618,18570,18573,18598,18562,18566,18599,22691,22699,22698,22697,22689,22681,22682,22683,14499,14506,14497,14490,14500,14514,14496,14482,14501,14522,14474,14502,14466,14503,10411,10409,10393,10395,10420,10416,10384,10388,10429,10381,10374,6316,6323,6321,6312,6296,6289,6291,6300,18660,18668,18667,18666,18658,18650,18651,18652,18661,18677,18675,18673,18657,18641,18643,18645,18662,18686,18683,18680,18656,18632,18635,18638,18663,18627,18631,22756,22764,22763,22762,22754,22746,22747,22748,14564,14571,14562,14555,14565,14579,14561,14547,14566,14587,14560,14539,14567,14531,10476,10474,10458,10460,10485,10481,10449,10453,10494,10488,10440,10446,10439,6381,6388,6386,6377,6361,6354,6356,6365,18725,18733,18732,18731,18723,18715,18716,18717,18726,18742,18740,18738,18722,18706,18708,18710,18727,18751,18748,18745,18721,18697,18700,18703,18720,18688,18692,22821,22829,22828,22827,22819,22811,22812,22813,14629,14636,14627,14620,14630,14644,14626,14612,14631,14652,14625,14604,14624,14596,10541,10539,10523,10525,10550,10546,10514,10518,10559,10553,10505,10511,10496,6446,6453,6451,6442,6426,6419,6421,6430,18790,18798,18797,18796,18788,18780,18781,18782,18791,18807,18805,18803,18787,18771,18773,18775,18813,18810,18786,18762,18765,18785,18753,18757,18784,22886,22894,22893,22892,22884,22876,22877,22878,14694,14701,14692,14685,14695,14709,14691,14677,14717,14690,14669,14689,14661,14688,10606,10604,10588,10590,10615,10611,10579,10583,10618,10570,10561,6511,6518,6516,6507,6491,6484,6486,6495,18855,18863,18862,18861,18853,18845,18846,18847,18870,18868,18852,18836,18838,18878,18875,18851,18827,18830,18850,18818,18822,18849,18848,22951,22959,22958,22957,22949,22941,22942,22943,14759,14766,14757,14750,14774,14756,14742,14782,14755,14734,14754,14726,14753,14752,10671,10669,10653,10655,10676,10644,10683,10635,10626,6583,6581,6572,6556,6549,6551,18927,18926,18918,18910,18911,18935,18933,18917,18901,18903,18943,18940,18916,18892,18895,18915,18883,18887,18914,18913,18912,23023,23022,23014,23006,23007,14831,14822,14815,14839,14821,14807,14847,14820,14799,14819,14791,14818,14817,14816,10734,10718,10741,10709,10748,10700,10691,6646,6637,6621,6614,18985,18993,18992,18976,18977,18986,19002,19e3,18968,18970,18987,18960,18963,18988,18952,18956,18989,18944,18949,18990,18991,23081,23089,23088,23072,23073,14889,14896,14880,14890,14904,14872,14891,14864,14892,14856,14893,14848,14894,14895,10801,10785,10810,10778,10771,10764,10757,6706,6713,6681,6690,19050,19058,19057,19056,19048,19040,19041,19042,19051,19067,19065,19033,19035,19052,19025,19028,19053,19017,19021,19054,19009,19014,19055,23146,23154,23153,23152,23144,23136,23137,23138,14954,14961,14952,14945,14955,14969,14937,14956,14929,14957,14921,14958,14913,14959,10866,10864,10848,10850,10875,10843,10836,10829,10822,6771,6778,6776,6744,6746,6755,19115,19123,19122,19121,19113,19105,19106,19107,19116,19132,19130,19128,19112,19096,19098,19100,19117,19090,19093,19118,19082,19086,19119,19074,19079,23211,23219,23218,23217,23209,23201,23202,23203,15019,15026,15017,15010,15020,15034,15016,15002,15021,14994,15022,14986,15023,14978,10931,10929,10913,10915,10940,10936,10904,10908,10901,10894,10887,6836,6843,6841,6832,6816,6809,6811,6820,19180,19188,19187,19186,19178,19170,19171,19172,19181,19197,19195,19193,19177,19161,19163,19165,19182,19176,19152,19155,19158,19183,19147,19151,19139,23276,23284,23283,23282,23274,23266,23267,23268,15084,15091,15082,15075,15085,15099,15081,15067,15086,15080,15059,15087,15051,15043,10996,10994,10978,10980,11005,11001,10969,10973,10960,10966,10959,6901,6908,6906,6897,6881,6874,6876,6885,19245,19253,19252,19251,19243,19235,19236,19237,19246,19262,19260,19258,19242,19226,19228,19230,19247,19241,19217,19220,19223,19240,19208,19212,19204,23341,23349,23348,23347,23339,23331,23332,23333,15149,15156,15147,15140,15150,15164,15146,15132,15151,15145,15124,15144,15116,15108,11061,11059,11043,11045,11070,11066,11034,11038,11025,11031,11016,6966,6973,6971,6962,6946,6939,6941,6950,19310,19318,19317,19316,19308,19300,19301,19302,19311,19327,19325,19323,19307,19291,19293,19295,19306,19282,19285,19305,19273,19277,19304,19264,19269,23406,23414,23413,23412,23404,23396,23397,23398,15214,15221,15212,15205,15215,15229,15211,15197,15210,15189,15209,15181,15208,15173,11126,11124,11108,11110,11135,11131,11099,11103,11090,11081,11072,7031,7038,7036,7027,7011,7004,7006,7015,19375,19383,19382,19381,19373,19365,19366,19367,19390,19388,19372,19356,19358,19371,19347,19350,19370,19338,19342,19369,19329,19334,19368,23471,23479,23478,23477,23469,23461,23462,23463,15279,15286,15277,15270,15294,15276,15262,15275,15254,15274,15246,15273,15238,15272,11191,11189,11173,11175,11196,11164,11155,11146,11137,7103,7101,7092,7076,7069,7071,19447,19446,19438,19430,19431,19455,19453,19437,19421,19423,19436,19412,19415,19435,19403,19407,19434,19394,19399,19433,19432,23543,23542,23534,23526,23527,15351,15342,15335,15359,15341,15327,15340,15319,15339,15311,15338,15303,15337,15336,11254,11238,11261,11229,11220,11211,11202,7166,7157,7141,7134,19505,19513,19512,19496,19497,19506,19488,19490,19507,19480,19483,19508,19472,19476,19509,19464,19469,19510,19456,19462,19511,23601,23609,23608,23592,23593,15409,15416,15400,15410,15392,15411,15384,15412,15376,15413,15368,15414,15360,15415,11321,11305,11298,11291,11284,11277,11270,7226,7201,7210,19570,19578,19577,19576,19568,19560,19561,19562,19571,19553,19555,19572,19545,19548,19573,19537,19541,19574,19529,19534,19575,19521,19527,23666,23674,23673,23672,23664,23656,23657,23658,15474,15481,15472,15465,15475,15457,15476,15449,15477,15441,15478,15433,15479,15425,11386,11384,11368,11370,11363,11356,11349,11342,11335,7291,7264,7266,7275,19635,19643,19642,19641,19633,19625,19626,19627,19636,19632,19616,19618,19620,19637,19610,19613,19638,19602,19606,19639,19594,19599,19586,23731,23739,23738,23737,23729,23721,23722,23723,15539,15546,15537,15530,15540,15536,15522,15541,15514,15542,15506,15543,15498,15490,11451,11449,11433,11435,11424,11428,11421,11414,11407,7356,7352,7336,7329,7331,7340,19700,19708,19707,19706,19698,19690,19691,19692,19701,19697,19681,19683,19685,19702,19696,19672,19675,19678,19703,19667,19671,19659,19651,23796,23804,23803,23802,23794,23786,23787,23788,15604,15611,15602,15595,15605,15601,15587,15606,15600,15579,15607,15571,15563,15555,11516,11514,11498,11500,11489,11493,11480,11486,11479,7421,7417,7401,7394,7396,7405,19765,19773,19772,19771,19763,19755,19756,19757,19766,19762,19746,19748,19750,19767,19761,19737,19740,19743,19760,19728,19732,19724,19716,23861,23869,23868,23867,23859,23851,23852,23853,15669,15676,15667,15660,15670,15666,15652,15671,15665,15644,15664,15636,15628,15620,11581,11579,11563,11565,11554,11558,11545,11551,11536,7486,7482,7466,7459,7461,7470,19830,19838,19837,19836,19828,19820,19821,19822,19831,19827,19811,19813,19815,19826,19802,19805,19825,19793,19797,19824,19784,19789,19781,23926,23934,23933,23932,23924,23916,23917,23918,15734,15741,15732,15725,15735,15731,15717,15730,15709,15729,15701,15728,15693,15685,11646,11644,11628,11630,11619,11623,11610,11601,11592,7551,7547,7531,7524,7526,7535,19895,19903,19902,19901,19893,19885,19886,19887,19892,19876,19878,19891,19867,19870,19890,19858,19862,19889,19849,19854,19888,19840,19846,23991,23999,23998,23997,23989,23981,23982,23983,15799,15806,15797,15790,15796,15782,15795,15774,15794,15766,15793,15758,15792,15750,11711,11709,11693,11695,11684,11675,11666,11657,11648,7612,7596,7589,7591,19967,19966,19958,19950,19951,19957,19941,19943,19956,19932,19935,19955,19923,19927,19954,19914,19919,19953,19905,19911,19952,24063,24062,24054,24046,24047,15871,15862,15855,15861,15847,15860,15839,15859,15831,15858,15823,15857,15815,15856,11774,11758,11749,11740,11731,11722,11713,7677,7661,7654,20025,20016,20017,20026,20008,20010,20027,2e4,20003,20028,19992,19996,20029,19984,19989,20030,19976,19982,20031,19968,19975,24121,24112,24113,15929,15920,15930,15912,15931,15904,15932,15896,15933,15888,15934,15880,15935,15872,11825,11818,11811,11804,11797,11790,11783,7721,7730,20090,20088,20080,20081,20082,20091,20073,20075,20092,20065,20068,20093,20057,20061,20094,20049,20054,20095,20041,20047,20033,24186,24184,24176,24177,24178,15994,15992,15985,15995,15977,15996,15969,15997,15961,15998,15953,15999,15945,15937,11888,11890,11883,11876,11869,11862,11855,7784,7786,7795,20155,20153,20145,20146,20147,20156,20152,20136,20138,20140,20157,20130,20133,20158,20122,20126,20159,20114,20119,20106,20098,24251,24249,24241,24242,24243,16059,16057,16050,16060,16056,16042,16061,16034,16062,16026,16063,16018,16010,16002,11953,11955,11944,11948,11941,11934,11927,7856,7849,7851,7860,20220,20218,20210,20211,20212,20221,20217,20201,20203,20205,20222,20216,20192,20195,20198,20223,20187,20191,20179,20171,20163,24316,24314,24306,24307,24308,16124,16122,16115,16125,16121,16107,16126,16120,16099,16127,16091,16083,16075,16067,12018,12020,12009,12013,12e3,12006,11999,7921,7914,7916,7925,20285,20283,20275,20276,20277,20286,20282,20266,20268,20270,20287,20281,20257,20260,20263,20280,20248,20252,20244,20236,20228,24381,24379,24371,24372,24373,16189,16187,16180,16190,16186,16172,16191,16185,16164,16184,16156,16148,16140,16132,12083,12085,12074,12078,12065,12071,12056,7986,7979,7981,7990,20350,20348,20340,20341,20342,20351,20347,20331,20333,20335,20346,20322,20325,20345,20313,20317,20344,20304,20309,20301,20293,24446,24444,24436,24437,24438,16254,16252,16245,16255,16251,16237,16250,16229,16249,16221,16248,16213,16205,16197,12148,12150,12139,12143,12130,12121,12112,8051,8044,8046,8055,20415,20413,20405,20406,20407,20412,20396,20398,20411,20387,20390,20410,20378,20382,20409,20369,20374,20408,20360,20366,20358,24511,24509,24501,24502,24503,16319,16317,16310,16316,16302,16315,16294,16314,16286,16313,16278,16312,16270,16262,12213,12215,12204,12195,12186,12177,12168,8116,8109,8111,20478,20470,20471,20477,20461,20463,20476,20452,20455,20475,20443,20447,20474,20434,20439,20473,20425,20431,20472,20416,20423,24574,24566,24567,16382,16375,16381,16367,16380,16359,16379,16351,16378,16343,16377,16335,16376,16327,12278,12269,12260,12251,12242,12233,12224,8181,8174,66,64,36928,41024,45120,49216,74,72,36936,41032,45128,49224,131,129,139,137,196,194,204,202,261,259,269,267,326,324,334,332,391,37255,41351,45447,49543,389,399,37263,41359,45455,49551,397,586,584,37448,41544,45640,49736,594,592,37456,41552,45648,49744,578,576,37440,41536,45632,49728,651,649,659,657,643,641,716,714,724,722,708,706,781,779,789,787,773,771,846,844,854,852,838,836,911,37775,41871,45967,50063,909,919,37783,41879,45975,50071,917,903,37767,41863,45959,50055,901,1106,1104,37968,42064,46160,50256,1114,1112,37976,42072,46168,50264,1098,1096,37960,42056,46152,50248,1171,1169,1179,1177,1163,1161,1236,1234,1244,1242,1228,1226,1301,1299,1309,1307,1293,1291,1366,1364,1374,1372,1358,1356,1431,38295,42391,46487,50583,1429,1439,38303,42399,46495,50591,1437,1423,38287,42383,46479,50575,1421,1626,1624,38488,42584,46680,50776,1634,1632,38496,42592,46688,50784,1618,1616,38480,42576,46672,50768,1691,1689,1699,1697,1683,1681,1756,1754,1764,1762,1748,1746,1821,1819,1829,1827,1813,1811,1886,1884,1894,1892,1878,1876,1951,38815,42911,47007,51103,1949,1959,38823,42919,47015,51111,1957,1943,38807,42903,46999,51095,1941,2146,2144,39008,43104,47200,51296,2154,2152,39016,43112,47208,51304,2138,2136,39e3,43096,47192,51288,2211,2209,2219,2217,2203,2201,2276,2274,2284,2282,2268,2266,2341,2339,2349,2347,2333,2331,2406,2404,2414,2412,2398,2396,2471,39335,43431,47527,51623,2469,2479,39343,43439,47535,51631,2477,2463,39327,43423,47519,51615,2461,2666,2664,39528,43624,47720,51816,2674,2672,39536,43632,47728,51824,2658,2656,39520,43616,47712,51808,2731,2729,2739,2737,2723,2721,2796,2794,2804,2802,2788,2786,2861,2859,2869,2867,2853,2851,2926,2924,2934,2932,2918,2916,2991,39855,43951,48047,52143,2989,2999,39863,43959,48055,52151,2997,2983,39847,43943,48039,52135,2981,3186,3184,40048,44144,48240,52336,3194,3192,40056,44152,48248,52344,3178,3176,40040,44136,48232,52328,3251,3249,3259,3257,3243,3241,3316,3314,3324,3322,3308,3306,3381,3379,3389,3387,3373,3371,3446,3444,3454,3452,3438,3436,3511,40375,44471,48567,52663,3509,3519,40383,44479,48575,52671,3517,3503,40367,44463,48559,52655,3501,3706,3704,40568,44664,48760,52856,3698,3696,40560,44656,48752,52848,3771,3769,3763,3761,3836,3834,3828,3826,3901,3899,3893,3891,3966,3964,3958,3956,4031,40895,44991,49087,53183,4029,4023,40887,44983,49079,53175,4021,67,587,1107,1627,2147,2667,3187,3707,388,908,1428,1948,2468,2988,3508,4028,26680,30720,55807,59847],binToReal=Object.fromEntries(realToBin.map((e,t)=>[e,t]));class ModelManager{constructor(e,t="chess-models"){this.modelUrl=e,this.storeName=t,this.dbName="ChessGameDB",this.dbVersion=1,this.db=null}async initDB(){return new Promise((e,t)=>{const n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e(this.db)},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName)}})}async getCachedModel(){return this.db||await this.initDB(),new Promise((e,t)=>{const n=this.db.transaction(this.storeName,"readonly").objectStore(this.storeName).get(this.modelUrl);n.onerror=()=>t(n.error),n.onsuccess=()=>e(n.result)})}async cacheModel(e){return this.db||await this.initDB(),new Promise((t,n)=>{const o=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).put(e,this.modelUrl);o.onerror=()=>n(o.error),o.onsuccess=()=>t()})}async downloadModel(e,t){try{const n=await fetch(this.modelUrl,{signal:t});if(!n.ok)throw new Error(`Failed to download model: ${n.statusText}`);const o=n.headers.get("content-length");if(!o)throw new Error("Server did not provide content-length header");const s=parseInt(o,10);let i=0;const a=n.body.getReader(),r=[];try{for(;;){const{done:t,value:n}=await a.read();if(t)break;r.push(n),i+=n.length;e&&e(i/s*100)}}catch(e){throw a.cancel(),e}const l=new Blob(r,{type:"application/octet-stream"});return await this.cacheModel(l),l}catch(e){throw console.error("[ModelManager] Download error:",e),e}}async getModel(e,t){try{const n=await this.getCachedModel();return n?(console.debug("[ModelManager] Using cached model"),e&&e(100),n):(console.debug("[ModelManager] Downloading model..."),await this.downloadModel(e,t))}catch(e){throw console.error("[ModelManager] Error getting model:",e),e}}async clearCache(){return this.db||await this.initDB(),new Promise((e,t)=>{const n=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).delete(this.modelUrl);n.onerror=()=>t(n.error),n.onsuccess=()=>e()})}}const pieceToInt={p:0,n:1,b:2,r:3,q:4,k:5},promotionToX0={n:9,b:10,r:11,q:12},x0ToPromotion=Object.fromEntries(Object.entries(promotionToX0).map(([e,t])=>[t,e])),uciToCastling={e1g1:26680,e1c1:30720,e8g8:55807,e8c8:59847},castlingToUci=Object.fromEntries(Object.entries(uciToCastling).map(([e,t])=>[t,e])),rankToIdx=e=>parseInt(e)-1,idxToRank=e=>String(e+1),fileToIdxMap={a:0,b:1,c:2,d:3,e:4,f:5,g:6,h:7},idxToFileMap=Object.fromEntries(Object.entries(fileToIdxMap).map(([e,t])=>[t,e])),fileToIdx=e=>fileToIdxMap[e],idxToFile=e=>idxToFileMap[e];class LocalONNXProvider{constructor(){this.session=null,this.isReady=!1,this.temperature=1,this.topK=1}async initSession(e){const t=URL.createObjectURL(e);try{ort.env.logLevel="error",this.session=await ort.InferenceSession.create(t,{logSeverityLevel:3,executionProviders:["webgpu","wasm"],preferredOutputLocation:"cpu"}),this.isReady=!0}finally{URL.revokeObjectURL(t)}}getLegalMoves(e){const t=Chess();for(const n of e)t.move(n,{sloppy:!0});return t.moves({verbose:!0})}async getMove(e){if(await new Promise(e=>setTimeout(e,100)),!this.isReady||!this.session)throw new Error("ONNX model not initialized");try{const t={x:this._moveHistoryToModelInput(e)},n=await this.session.run(t),o=this.getLegalMoves(e).map(e=>this.moveDataToBin(this.moveToMoveData(e))),{sampledBinMove:s,topCandidates:i}=this._modelSampleBinMove(n,o),a=this.binMoveToUCI(s);return{uciMove:a,topMoves:i.map(e=>{const t=this.binMoveToUCI(e.binMove);return{from:t.substring(0,2),to:t.substring(2,4),probability:e.probability,isChosen:e.binMove===s}})}}catch(e){return console.error("Error during ONNX inference:",e),null}}async opponentMove(e){}async reset(){}moveToMoveData(e){return{fromFile:fileToIdx(e.from[0]),fromRank:rankToIdx(e.from[1]),toFile:fileToIdx(e.to[0]),toRank:rankToIdx(e.to[1]),role:pieceToInt[e.piece],castlingMove:uciToCastling[e],promotion:promotionToX0[e.promotion]}}moveDataToBin(e){if(e.castlingMove)return e.castlingMove;{const{fromFile:t,fromRank:n,toFile:o,toRank:s,role:i,promotion:a}=e;return(a||i)<<12|t<<9|n<<6|o<<3|s}}binMoveToUCI(e){const t=e>>12&15,n=idxToFile(e>>9&7),o=idxToRank(e>>6&7),s=idxToFile(e>>3&7),i=idxToRank(7&e),a=castlingToUci[e];if(a)return a;return n+o+s+i+x0ToPromotion[t]}_moveHistoryToModelInput(e){const t=Chess(),n=[];for(const o of e){const e=t.move(o,{sloppy:!0});n.push(this.moveToMoveData(e))}const o=[32774];for(const e of n)if(e.castlingMove)o.push(e.castlingMove);else{const{fromFile:t,fromRank:n,toFile:s,toRank:i,role:a,promotion:r}=e,l=(r||a)<<12|t<<9|n<<6|s<<3|i;o.push(l)}return new ort.Tensor("int64",BigInt64Array.from(o.map(e=>BigInt(e))),[1,o.length])}_modelSampleBinMove(e,t){const n=e.select_8.cpuData,o=t.map(e=>binToReal[e]).map(e=>({token:e,logit:n[e]}));if(o.sort((e,t)=>t.logit-e.logit),this.temperature<=0||this.topK<=1){if(0===o.length)return console.error("Uh oh, no legal moves!?!?!?"),{sampledBinMove:0,topCandidates:[]};const e=o[0].logit,t=o.map(t=>Math.exp(t.logit-e)),n=t.reduce((e,t)=>e+t,0),s=t[0]/n;return{sampledBinMove:realToBin[o[0].token],topCandidates:[{binMove:realToBin[o[0].token],probability:s}]}}const s=o.slice(0,this.topK),i=s.map(e=>e.logit/this.temperature),a=i[0],r=i.map(e=>Math.exp(e-a)),l=r.reduce((e,t)=>e+t,0),c=r.map(e=>e/l),d=s.map((e,t)=>({binMove:realToBin[e.token],probability:c[t]})),h=Math.random();let m=0,p=s.length-1;for(let e=0;e<c.length;e++)if(m+=c[e],h<m){p=e;break}return{sampledBinMove:realToBin[s[p].token],topCandidates:d}}}class ChessGameUIManager{constructor(e){if("string"==typeof e){if(this.container=document.getElementById(e),!this.container)throw new Error(`Container element with id "${e}" not found`)}else this.container=e;this.boardElement=null,this.statusElement=null,this.moveHistoryElement=null,this.controlPanelElement=null,this.gameOverlayElement=null,this.loadingModalElement=null,this.loadingBlurElement=null,this.currentMoveIndex=-1,this.moves=[],this.isGameOver=!1,this.samplingParams={temperature:1,topK:1},this.models=[],this.currentLoadedModelPath=null,this._probabilityArrowIds=[],this.onNewGameWithColor=null,this.onMoveNavigate=null,this.onSamplingParamsChanged=null,this.onLoadModel=null,this.onShowProbabilitiesChanged=null}initialize(){this.buildDOM(),this.applyStyles(),this.setupEventListeners()}buildDOM(){this.container.innerHTML="",this.container.className="chess-game-container";const e=document.createElement("div");e.className="chess-game-wrapper";const t=document.createElement("div");t.className="chess-game-left";const n=document.createElement("div");n.id="board",n.className="chess-board-container",t.appendChild(n),this.boardElement=n,this.controlPanelElement=document.createElement("div"),this.controlPanelElement.className="chess-control-panel";const o=document.createElement("button");o.id="newGameBtn",o.className="chess-btn chess-btn-primary",o.textContent="New Game",o.onclick=()=>this.showNewGameModal(),this.controlPanelElement.appendChild(o),t.appendChild(this.controlPanelElement),this.gameOverlayElement=document.createElement("div"),this.gameOverlayElement.className="chess-game-overlay chess-hidden";const s=document.createElement("div");s.className="chess-game-overlay-content";const i=document.createElement("div");i.className="chess-game-overlay-text",i.id="overlayText",s.appendChild(i);const a=document.createElement("div");a.style="display: flex; justify-content: space-between;",s.appendChild(a);const r=document.createElement("button");r.className="chess-btn chess-btn-primary",r.textContent="Play Again",r.onclick=()=>this.showNewGameModal(),a.appendChild(r);const l=document.createElement("button");l.className="chess-btn chess-btn-danger",l.textContent="Close",l.onclick=()=>this.hideGameOverlay(),a.appendChild(l),this.gameOverlayElement.appendChild(s),this.boardElement.parentElement.appendChild(this.gameOverlayElement);const c=document.createElement("div");c.className="chess-game-right";const d=document.createElement("div");d.className="chess-status",this.statusElement=document.createElement("div"),this.statusElement.id="gameStatus",this.statusElement.className="chess-status-text",d.appendChild(this.statusElement);const h=document.createElement("button");h.className="chess-settings-btn",h.title="Sampling settings",h.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.062 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg>',h.onclick=()=>this.toggleSettingsPanel(),d.appendChild(h),c.appendChild(d),this.settingsPanelElement=document.createElement("div"),this.settingsPanelElement.className="chess-settings-panel chess-hidden",this._buildSettingsPanel(),c.appendChild(this.settingsPanelElement),this.moveHistoryElement=document.createElement("div"),this.moveHistoryElement.className="chess-move-history",c.appendChild(this.moveHistoryElement),e.appendChild(t),e.appendChild(c),this.container.appendChild(e)}applyStyles(){const e=document.createElement("style");e.textContent='\n            .chess-game-container {\n                position: relative;\n                font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n                padding: 20px;\n            }\n\n            .chess-game-wrapper {\n                display: grid;\n                grid-template-columns: auto 1fr;\n                gap: 20px;\n            }\n\n            .chess-game-left {\n                max-width: 480px;\n            }\n\n            .chess-board-container {\n                position: relative;\n                width: 100%;\n                max-width: 480px;\n                margin-bottom: 15px;\n            }\n\n            .chess-control-panel {\n                display: flex;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .chess-btn {\n                padding: 10px 16px;\n                border: none;\n                border-radius: 4px;\n                font-size: 14px;\n                font-weight: 600;\n                cursor: pointer;\n                transition: all 0.2s ease;\n            }\n\n            .chess-btn-primary {\n                background-color: #1f7506;\n                color: white;\n            }\n\n            .chess-btn-primary:hover {\n                background-color: #186204;\n                transform: scale(1.02);\n            }\n\n            .chess-btn-primary:active {\n                transform: scale(0.98);\n            }\n\n            .chess-game-right {\n                min-width: 250px;\n                max-width: 480px;\n                min-height: 0;\n                display: flex;\n                flex-direction: column;\n            }\n\n            .chess-status {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 12px 16px;\n                background-color: #f5f5f5;\n                border-radius: 4px;\n                margin-bottom: 15px;\n                font-size: 14px;\n                line-height: 1.5;\n                border-left: 4px solid #1f7506;\n            }\n\n            .chess-status-text {\n                flex: 1;\n            }\n\n            .chess-settings-btn {\n                background: none;\n                border: none;\n                cursor: pointer;\n                color: #666;\n                padding: 4px;\n                border-radius: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: color 0.2s ease, background-color 0.2s ease;\n                flex-shrink: 0;\n                margin-left: 8px;\n            }\n\n            .chess-settings-btn:hover {\n                color: #1f7506;\n                background-color: #e8e8e8;\n            }\n\n            .chess-settings-panel {\n                background-color: #f9f9f9;\n                border: 1px solid #e0e0e0;\n                border-radius: 4px;\n                padding: 12px 16px;\n                margin-bottom: 15px;\n            }\n\n            .chess-settings-panel.chess-hidden {\n                display: none;\n            }\n\n            .chess-settings-field {\n                margin-bottom: 8px;\n            }\n\n            .chess-settings-field:last-child {\n                margin-bottom: 0;\n            }\n\n            .chess-settings-field label {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                font-size: 13px;\n                font-weight: 600;\n                color: #333;\n                margin-bottom: 4px;\n            }\n\n            .chess-settings-field label span {\n                font-weight: 400;\n                color: #666;\n                font-size: 13px;\n            }\n\n            .chess-settings-field input[type="range"] {\n                width: 100%;\n                accent-color: #1f7506;\n            }\n\n            .chess-settings-field input[type="checkbox"] {\n                cursor: pointer;\n                vertical-align: middle;\n            }\n\n            .chess-settings-field label.chess-checkbox-label {\n                justify-content: flex-start;\n                gap: 0;\n            }\n\n            .chess-probability-labels {\n                pointer-events: none;\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                z-index: 30;\n            }\n\n            .chess-probability-label {\n                position: absolute;\n                transform: translate(-100%, 0);\n                background-color: rgba(0, 0, 0, 0.7);\n                color: white;\n                font-size: 11px;\n                font-weight: 600;\n                padding: 1px 4px;\n                border-radius: 3px;\n                pointer-events: none;\n                white-space: nowrap;\n            }\n\n            .chess-model-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n\n            .chess-model-row select {\n                flex: 1;\n                padding: 6px 8px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                font-size: 13px;\n                font-family: inherit;\n            }\n\n            .chess-btn-sm {\n                padding: 6px 12px;\n                font-size: 12px;\n            }\n\n.chess-move-history {\n                background-color: #f9f9f9;\n                border: 1px solid #e0e0e0;\n                border-radius: 4px;\n                padding: 12px;\n                flex: 1;\n                min-height: 0;\n                overflow-y: auto;\n            }\n\n            .chess-move-history-empty {\n                color: #999;\n                font-size: 13px;\n                font-style: italic;\n            }\n\n            .chess-move-pair {\n                display: grid;\n                grid-template-columns: 30px 1fr 1fr;\n                gap: 12px;\n                margin-bottom: 8px;\n                font-size: 14px;\n                line-height: 1.6;\n            }\n\n            .chess-move-number {\n                color: #666;\n                font-weight: 600;\n            }\n\n            .chess-move-item {\n                padding: 4px 8px;\n                border-radius: 3px;\n                cursor: pointer;\n                transition: background-color 0.15s ease;\n            }\n\n            .chess-move-item:hover {\n                background-color: #e8e8e8;\n            }\n\n            .chess-move-item.current {\n                background-color: #1f7506;\n                color: white;\n                font-weight: 600;\n            }\n\n            .chess-game-overlay {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background-color: rgba(0, 0, 0, 0.7);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                border-radius: 4px;\n                z-index: 100;\n                animation: fadeIn 0.3s ease;\n            }\n\n            .chess-game-overlay.chess-hidden {\n                display: none;\n            }\n\n            @keyframes fadeIn {\n                from {\n                    opacity: 0;\n                }\n                to {\n                    opacity: 1;\n                }\n            }\n\n            /* Loading modal and blur */\n            .chess-loading-blur {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background-color: rgba(255, 255, 255, 0.3);\n                backdrop-filter: blur(2px);\n                border-radius: 4px;\n                z-index: 50;\n            }\n\n            .chess-loading-modal {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 200;\n                animation: fadeIn 0.3s ease;\n            }\n\n            .chess-loading-modal-content {\n                background-color: white;\n                padding: 40px;\n                border-radius: 12px;\n                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n                text-align: center;\n                min-width: 300px;\n                max-width: 400px;\n            }\n\n            .chess-loading-modal-content h2 {\n                margin-top: 0;\n                margin-bottom: 20px;\n                color: #333;\n                font-size: 24px;\n            }\n\n            .chess-loading-description {\n                font-size: 14px;\n                color: #666;\n                margin-bottom: 30px;\n                line-height: 1.6;\n            }\n\n            .chess-loading-progress-container {\n                margin-bottom: 25px;\n            }\n\n            .chess-loading-progress-bar {\n                width: 100%;\n                height: 8px;\n                background-color: #e0e0e0;\n                border-radius: 4px;\n                overflow: hidden;\n                margin-bottom: 10px;\n            }\n\n            .chess-loading-progress-fill {\n                height: 100%;\n                background-color: #1f7506;\n                width: 0%;\n                transition: width 0.1s linear;\n            }\n\n            .chess-loading-progress-text {\n                font-size: 13px;\n                color: #999;\n                text-align: right;\n            }\n\n            .chess-btn:disabled {\n                opacity: 0.6;\n                cursor: not-allowed;\n            }\n\n            .chess-game-overlay-content {\n                background-color: white;\n                padding: 32px;\n                border-radius: 8px;\n                text-align: center;\n                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n            }\n\n            .chess-game-overlay-text {\n                font-size: 24px;\n                font-weight: 700;\n                margin-bottom: 24px;\n                color: #333;\n            }\n\n            /* Check highlight animation */\n            .chess-square.chess-king-check {\n                animation: checkHighlight 0.4s ease;\n            }\n\n            @keyframes checkHighlight {\n                0% {\n                    background-color: transparent;\n                }\n                50% {\n                    background-color: rgba(255, 165, 0, 0.7);\n                }\n                100% {\n                    background-color: rgba(255, 165, 0, 0.5);\n                }\n            }\n\n            /* Last move highlights */\n            .chess-last-move-from {\n                background-color: rgba(186, 202, 43, 0.5) !important;\n            }\n\n            .chess-last-move-to {\n                background-color: rgba(186, 202, 43, 0.7) !important;\n            }\n\n            /* Modal for new game color selection */\n            .chess-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background-color: rgba(0, 0, 0, 0.5);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 200;\n            }\n\n            .chess-modal-content {\n                background-color: white;\n                padding: 32px;\n                border-radius: 8px;\n                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n                text-align: center;\n            }\n\n            .chess-modal-title {\n                font-size: 20px;\n                font-weight: 700;\n                margin-bottom: 20px;\n                color: #333;\n            }\n\n            .chess-color-options {\n                display: flex;\n                gap: 16px;\n                margin-bottom: 24px;\n                justify-content: center;\n            }\n\n            .chess-color-option {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                padding: 12px 16px;\n                border: 2px solid #e0e0e0;\n                border-radius: 4px;\n                transition: border-color 0.2s ease;\n            }\n\n            .chess-color-option:hover {\n                border-color: #1f7506;\n            }\n\n            .chess-color-option input[type="radio"] {\n                cursor: pointer;\n            }\n\n            .chess-color-option input[type="radio"]:checked + label {\n                font-weight: 600;\n            }\n\n            /* Promotion popup (lichess/chess.com style) */\n            .chess-promotion-overlay {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                z-index: 150;\n            }\n\n            .chess-promotion-popup {\n                position: absolute;\n                display: flex;\n                flex-direction: column;\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);\n                border-radius: 2px;\n                overflow: hidden;\n            }\n\n            .chess-promotion-piece {\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .chess-promotion-piece:hover {\n                background-color: rgba(31, 117, 6, 0.5) !important;\n            }\n\n            .chess-promotion-piece img {\n                width: 90%;\n                height: 90%;\n                pointer-events: none;\n            }\n\n            .chess-modal-buttons {\n                display: flex;\n                gap: 12px;\n                justify-content: center;\n            }\n\n            .chess-btn-secondary {\n                background-color: #999;\n                color: white;\n            }\n\n            .chess-btn-secondary:hover {\n                background-color: #777;\n            }\n\n            .chess-btn-danger {\n                background-color: #d32f2f;\n                color: white;\n            }\n\n            .chess-btn-danger:hover {\n                background-color: #b71c1c;\n            }\n\n            /* Board blocker - prevents all interaction until model is ready */\n            .chess-board-blocker {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background-color: rgba(0, 0, 0, 0.35);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 40;\n                cursor: pointer;\n                border-radius: 4px;\n            }\n\n            .chess-board-blocker-silent {\n                background-color: transparent;\n                cursor: default;\n            }\n\n            .chess-board-blocker-content {\n                color: white;\n                font-size: 18px;\n                font-weight: 600;\n                text-align: center;\n                pointer-events: none;\n            }\n\n            .chess-spinner {\n                width: 36px;\n                height: 36px;\n                border: 4px solid rgba(255, 255, 255, 0.3);\n                border-top: 4px solid white;\n                border-radius: 50%;\n                animation: spin 0.8s linear infinite;\n                margin: 0 auto;\n            }\n\n            .chess-spinner.chess-spinner-dark {\n                border-color: rgba(0, 0, 0, 0.1);\n                border-top-color: #1f7506;\n            }\n\n            @keyframes spin {\n                to { transform: rotate(360deg); }\n            }\n\n            @media (max-width: 768px) {\n                .chess-game-container {\n                    padding: 10px;\n                }\n\n                .chess-game-wrapper {\n                    grid-template-columns: 1fr;\n                }\n\n                .chess-board-container {\n                    max-width: 100%;\n                }\n\n                .chess-game-right {\n                    min-width: auto;\n                    min-height: auto;\n                }\n\n                .chess-move-history {\n                    max-height: 300px;\n                }\n            }\n        ',document.head.appendChild(e)}setupEventListeners(){}updateStatus(e){this.statusElement.innerHTML=e}updateMoveHistory(e,t){if(this.moves=e,this.currentMoveIndex=t,0===e.length)return void(this.moveHistoryElement.innerHTML='<div class="chess-move-history-empty">No moves yet</div>');const n=[];for(let o=0;o<e.length;o+=2){const s=Math.floor(o/2)+1,i=e[o],a=e[o+1],r=document.createElement("div");r.className="chess-move-pair";const l=document.createElement("div");l.className="chess-move-number",l.textContent=`${s}.`,r.appendChild(l);const c=document.createElement("div");if(c.className="chess-move-item",t===o&&c.classList.add("current"),c.textContent=i.san,c.onclick=()=>this.onMoveNavigate?.(o),r.appendChild(c),a){const e=document.createElement("div");e.className="chess-move-item",t===o+1&&e.classList.add("current"),e.textContent=a.san,e.onclick=()=>this.onMoveNavigate?.(o+1),r.appendChild(e)}n.push(r)}this.moveHistoryElement.innerHTML="",n.forEach(e=>this.moveHistoryElement.appendChild(e)),this.moveHistoryElement.scrollTop=this.moveHistoryElement.scrollHeight}getBoardElementId(){return"board"}getBoardElement(){return this.boardElement}highlightLastMove(e,t){if(this.clearLastMoveHighlight(),!e||!t)return;const n=document.querySelector(`[data-square="${e}"]`),o=document.querySelector(`[data-square="${t}"]`);n&&n.classList.add("chess-last-move-from"),o&&o.classList.add("chess-last-move-to")}showCheck(e){}clearLastMoveHighlight(){document.querySelectorAll(".chess-last-move-from, .chess-last-move-to").forEach(e=>{e.classList.remove("chess-last-move-from","chess-last-move-to")})}showGameOverlay(e){this.isGameOver=!0;document.getElementById("overlayText").textContent=e,this.gameOverlayElement.classList.remove("chess-hidden")}hideGameOverlay(){this.isGameOver=!1,this.gameOverlayElement.classList.add("chess-hidden")}showPromotionDialog(e,t){return new Promise(n=>{const o=this.boardElement.querySelector(`[data-square="${e}"]`);if(!o)return void n("q");const s=this.boardElement.getBoundingClientRect(),i=o.getBoundingClientRect(),a=i.width,r=i.top-s.top<s.height/2,l=e.charCodeAt(0)-"a".charCodeAt(0),c=parseInt(e[1]),d=document.createElement("div");d.className="chess-promotion-overlay",d.onclick=e=>{e.target===d&&(d.remove(),n(null))};const h=document.createElement("div");h.className="chess-promotion-popup",h.style.left=i.left-s.left+"px",h.style.width=a+"px",r?h.style.top=i.top-s.top+"px":h.style.bottom=s.bottom-i.bottom+"px";const m="w"===t?"w":"b";["q","r","b","n"].forEach((e,o)=>{const s=(l+(r?c-o:c+o))%2==0,i=document.createElement("div");i.className="chess-promotion-piece",i.style.width=a+"px",i.style.height=a+"px",i.style.backgroundColor=s?"#f0d9b5":"#b58863";const p=m+e.toUpperCase(),g=this._getPieceImageUrl(p);if(g){const e=document.createElement("img");e.src=g,i.appendChild(e)}else{const n="w"===t?{q:"",r:"",b:"",n:""}:{q:"",r:"",b:"",n:""};i.textContent=n[e],i.style.fontSize=.7*a+"px",i.style.lineHeight="1"}i.onclick=t=>{t.stopPropagation(),d.remove(),n(e)},h.appendChild(i)}),d.appendChild(h),this.boardElement.appendChild(d)})}_getPieceImageUrl(e){if(!this._pieceImageTemplate){const e=this.boardElement.querySelectorAll("img");for(const t of e){const e=t.getAttribute("src")||"",n=e.match(/([wb][KQRBNP])(?=\.\w+$)/);if(n){this._pieceImageTemplate={src:e,matched:n[0]};break}}}return this._pieceImageTemplate?this._pieceImageTemplate.src.replace(this._pieceImageTemplate.matched,e):null}showDownloadModal(e){const t=new AbortController;this.loadingBlurElement=document.createElement("div"),this.loadingBlurElement.className="chess-loading-blur",this.container.appendChild(this.loadingBlurElement),this.loadingModalElement=document.createElement("div"),this.loadingModalElement.className="chess-loading-modal";const n=document.createElement("div");n.className="chess-loading-modal-content";const o=document.createElement("p");o.className="chess-loading-description";const s=e?`<br><strong>File size:</strong> ${e}`:"";o.innerHTML="Downloading chess AI."+s,n.appendChild(o);const i=document.createElement("div");i.className="chess-loading-progress-container";const a=document.createElement("div");a.className="chess-loading-progress-bar",this.loadingProgressBar=a;const r=document.createElement("div");r.className="chess-loading-progress-fill",this.loadingProgressFill=r,a.appendChild(r),i.appendChild(a);const l=document.createElement("div");l.className="chess-loading-progress-text",l.textContent="0%",this.loadingProgressText=l,i.appendChild(l),n.appendChild(i);const c=document.createElement("button");return c.className="chess-btn chess-btn-danger",c.textContent="Cancel",c.onclick=()=>t.abort(),n.appendChild(c),this.loadingModalElement.appendChild(n),this.container.appendChild(this.loadingModalElement),{abortController:t}}updateLoadingProgress(e){this.loadingProgressFill&&(this.loadingProgressFill.style.width=e+"%"),this.loadingProgressText&&(this.loadingProgressText.textContent=Math.round(e)+"%")}hideDownloadModal(){this.loadingModalElement&&(this.loadingModalElement.remove(),this.loadingModalElement=null),this.loadingBlurElement&&(this.loadingBlurElement.remove(),this.loadingBlurElement=null),this.loadingProgressFill=null,this.loadingProgressText=null}showMustDownloadOverlay(){return new Promise(e=>{this.mustDownloadOverlayElement=document.createElement("div"),this.mustDownloadOverlayElement.className="chess-loading-blur",this.container.appendChild(this.mustDownloadOverlayElement),this.mustDownloadModalElement=document.createElement("div"),this.mustDownloadModalElement.className="chess-loading-modal";const t=document.createElement("div");t.className="chess-loading-modal-content";const n=document.createElement("p");n.className="chess-loading-description",n.textContent="Download the AI model to play",t.appendChild(n);const o=document.createElement("button");o.className="chess-btn chess-btn-primary",o.textContent="Download",o.onclick=()=>{this.hideMustDownloadOverlay(),e()},t.appendChild(o),this.mustDownloadModalElement.appendChild(t),this.container.appendChild(this.mustDownloadModalElement)})}hideMustDownloadOverlay(){this.mustDownloadOverlayElement&&(this.mustDownloadOverlayElement.remove(),this.mustDownloadOverlayElement=null),this.mustDownloadModalElement&&(this.mustDownloadModalElement.remove(),this.mustDownloadModalElement=null)}showBoardBlocker(e){this.boardBlockerElement=document.createElement("div"),this.boardBlockerElement.className="chess-board-blocker";const t=document.createElement("div");t.className="chess-board-blocker-content",t.textContent="Click to load AI",this.boardBlockerElement.appendChild(t),this.boardBlockerElement.addEventListener("click",e,{once:!0}),this.boardElement.appendChild(this.boardBlockerElement)}showSilentBoardBlocker(){this.boardBlockerElement=document.createElement("div"),this.boardBlockerElement.className="chess-board-blocker chess-board-blocker-silent",this.boardBlockerElement.addEventListener("pointerdown",()=>{this.showInitializingOverlay()},{once:!0}),this.boardElement.appendChild(this.boardBlockerElement)}showInitializingOverlay(){this.initBlurElement=document.createElement("div"),this.initBlurElement.className="chess-loading-blur",this.container.appendChild(this.initBlurElement),this.initModalElement=document.createElement("div"),this.initModalElement.className="chess-loading-modal";const e=document.createElement("div");e.className="chess-loading-modal-content";const t=document.createElement("p");t.className="chess-loading-description",t.textContent="Initializing chess AI...",e.appendChild(t);const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="center";const o=document.createElement("div");o.className="chess-spinner chess-spinner-dark",n.appendChild(o),e.appendChild(n),this.initModalElement.appendChild(e),this.container.appendChild(this.initModalElement)}hideInitializingOverlay(){this.initModalElement&&(this.initModalElement.remove(),this.initModalElement=null),this.initBlurElement&&(this.initBlurElement.remove(),this.initBlurElement=null)}hideBoardBlocker(){this.boardBlockerElement&&(this.boardBlockerElement.remove(),this.boardBlockerElement=null)}showNewGameModal(){const e=document.createElement("div");e.className="chess-modal";const t=document.createElement("div");t.className="chess-modal-content";const n=document.createElement("div");n.className="chess-modal-title",n.textContent="Play as:",t.appendChild(n);const o=document.createElement("div");o.className="chess-color-options";const s=document.createElement("label");s.className="chess-color-option";const i=document.createElement("input");i.type="radio",i.name="playerColor",i.value="white",i.checked=!0,s.appendChild(i);const a=document.createElement("label");a.textContent=" White",a.style.cursor="pointer",a.style.marginBottom="0",s.appendChild(a),o.appendChild(s);const r=document.createElement("label");r.className="chess-color-option";const l=document.createElement("input");l.type="radio",l.name="playerColor",l.value="black",r.appendChild(l);const c=document.createElement("label");c.textContent=" Black",c.style.cursor="pointer",c.style.marginBottom="0",r.appendChild(c),o.appendChild(r),t.appendChild(o);const d=document.createElement("div");d.className="chess-modal-buttons";const h=document.createElement("button");h.className="chess-btn chess-btn-secondary",h.textContent="Cancel",h.onclick=()=>e.remove(),d.appendChild(h);const m=document.createElement("button");m.className="chess-btn chess-btn-primary",m.textContent="Start",m.onclick=()=>{const t=document.querySelector('input[name="playerColor"]:checked').value;this.onNewGameWithColor?.("white"===t),e.remove()},d.appendChild(m),t.appendChild(d),e.appendChild(t),document.body.appendChild(e)}toggleSettingsPanel(){this.settingsPanelElement.classList.toggle("chess-hidden")}_buildSettingsPanel(){const e=this.settingsPanelElement,t=document.createElement("div");t.className="chess-settings-field";const n=document.createElement("label"),o=document.createElement("span");o.textContent=this.samplingParams.temperature.toFixed(1),n.textContent="Temperature ",n.appendChild(o),t.appendChild(n);const s=document.createElement("input");s.type="range",s.min="0",s.max="2",s.step="0.1",s.value=this.samplingParams.temperature,s.oninput=()=>{const e=parseFloat(s.value);o.textContent=e.toFixed(1),this.samplingParams.temperature=e,this.onSamplingParamsChanged?.(this.samplingParams)},t.appendChild(s),e.appendChild(t);const i=document.createElement("div");i.className="chess-settings-field";const a=document.createElement("label"),r=document.createElement("span");r.textContent=this.samplingParams.topK,a.textContent="Top K ",a.appendChild(r),i.appendChild(a);const l=document.createElement("input");l.type="range",l.min="1",l.max="20",l.step="1",l.value=this.samplingParams.topK,l.oninput=()=>{const e=parseInt(l.value);r.textContent=e,this.samplingParams.topK=e,this.onSamplingParamsChanged?.(this.samplingParams)},i.appendChild(l),e.appendChild(i);const c=document.createElement("div");c.className="chess-settings-field";const d=document.createElement("label");d.className="chess-checkbox-label",d.style.cursor="pointer",this._probCheckbox=document.createElement("input"),this._probCheckbox.type="checkbox",this._probCheckbox.checked=!1,this._probCheckbox.style.accentColor="#1f7506",this._probCheckbox.style.marginRight="6px",this._probCheckbox.onchange=()=>{this.onShowProbabilitiesChanged?.(this._probCheckbox.checked)},d.appendChild(this._probCheckbox),d.appendChild(document.createTextNode("Show Probabilities")),c.appendChild(d),e.appendChild(c);const h=document.createElement("div");h.className="chess-settings-field";const m=document.createElement("label");m.textContent="Model",h.appendChild(m);const p=document.createElement("div");p.className="chess-model-row",this._modelSelect=document.createElement("select"),p.appendChild(this._modelSelect),this._modelLoadBtn=document.createElement("button"),this._modelLoadBtn.className="chess-btn chess-btn-primary chess-btn-sm",this._modelLoadBtn.textContent="Load",this._modelLoadBtn.disabled=!0,this._modelLoadBtn.onclick=()=>{const e=this._modelSelect.value;this.onLoadModel?.(e)},p.appendChild(this._modelLoadBtn),this._modelSelect.onchange=()=>{this._updateLoadBtnState()},h.appendChild(p),e.appendChild(h)}setModelOptions(e,t){if(this.models=e,this.currentLoadedModelPath=t,this._modelSelect){this._modelSelect.innerHTML="";for(const t of e){const e=document.createElement("option");e.value=t.path,e.textContent=t.size?`${t.label} (${t.size})`:t.label,this._modelSelect.appendChild(e)}t&&(this._modelSelect.value=t),this._updateLoadBtnState()}}setCurrentModel(e){this.currentLoadedModelPath=e,this._updateLoadBtnState()}_updateLoadBtnState(){this._modelLoadBtn&&this._modelSelect&&(this._modelLoadBtn.disabled=this._modelSelect.value===this.currentLoadedModelPath)}setBoard(e){this.board=e}clearCircles(){this.board&&this.board.clearCircles&&this.board.clearCircles()}addCircle(e){this.board&&this.board.addCircle&&this.board.addCircle(e)}setShowProbabilitiesChecked(e){this._probCheckbox&&(this._probCheckbox.checked=e)}showMoveArrows(e){if(this.clearMoveArrows(),!this.board||!this.board.addArrow)return;const t=[...e].sort((e,t)=>(e.isChosen?1:0)-(t.isChosen?1:0));for(const e of t){const t=e.isChosen?"#e69500":"#5b9bd5",n=(e.isChosen,this.board.addArrow({start:e.from,end:e.to,color:t,opacity:"75%",size:e.probability}));this._probabilityArrowIds.push(n)}this._showProbabilityLabels(e)}_showProbabilityLabels(e){this._probabilityLabelContainer=document.createElement("div"),this._probabilityLabelContainer.className="chess-probability-labels",this.boardElement.appendChild(this._probabilityLabelContainer);const t=this.boardElement.getBoundingClientRect();for(const n of e){const e=this.boardElement.querySelector(`[data-square="${n.to}"]`);if(!e)continue;const o=e.getBoundingClientRect(),s=document.createElement("div");s.className="chess-probability-label",s.textContent=Math.round(100*n.probability)+"%",s.style.left=o.right-t.left+"px",s.style.top=o.top-t.top+"px",this._probabilityLabelContainer.appendChild(s)}}clearMoveArrows(){if(this.board&&this.board.removeArrow)for(const e of this._probabilityArrowIds)this.board.removeArrow(e);this._probabilityArrowIds=[],this._probabilityLabelContainer&&(this._probabilityLabelContainer.remove(),this._probabilityLabelContainer=null)}}class ChessGame{constructor({models:e,containerId:t}){this.models=e,this.currentModelPath=e[0].path,this.modelManager=new ModelManager(this.currentModelPath),this.aiProvider=new LocalONNXProvider,this.uiManager=new ChessGameUIManager(t),this.game=new Chess,this.board=null,this.moveHistory=[],this._modelsByPath=Object.fromEntries(e.map(e=>[e.path,e])),this.isHumanWhite=!0,this.gameInProgress=!1,this.currentPositionIndex=-1,this.showProbabilities=!1}async init(){this.uiManager.initialize();const e={draggable:!0,position:this.game.fen(),orientation:this.isHumanWhite?"white":"black",onDragStart:this.onDragStart.bind(this),onDrop:this.onDrop.bind(this)};this.board=Chessboard2(this.uiManager.getBoardElementId(),e),this.uiManager.setBoard(this.board),new ResizeObserver(()=>{this.board&&this.board.resize&&this.board.resize()}).observe(this.uiManager.getBoardElement()),this.uiManager.onNewGameWithColor=this.startNewGame.bind(this),this.uiManager.onMoveNavigate=this.navigateToMove.bind(this),this.uiManager.onSamplingParamsChanged=e=>{const t=this.aiProvider.topK!==e.topK;this.aiProvider.temperature=e.temperature,this.aiProvider.topK=e.topK,t&&(this.showProbabilities=!0,this.uiManager.setShowProbabilitiesChecked(!0))},this.uiManager.onLoadModel=e=>this.loadModelByPath(e),this.uiManager.onShowProbabilitiesChanged=e=>{this.showProbabilities=e,e||this.uiManager.clearMoveArrows()},this.uiManager.setModelOptions(this.models,null),this.updateStatus(),this.updateMoveHistory(),await this.loadInitialModel()}async loadInitialModel(){const e=await this.modelManager.getCachedModel();e?(this.uiManager.showSilentBoardBlocker(),await this.aiProvider.initSession(e),this.uiManager.hideInitializingOverlay(),this.uiManager.hideBoardBlocker(),this.uiManager.setCurrentModel(this.currentModelPath),await this.startGame()):this.uiManager.showBoardBlocker(()=>this.beginDownloadFlow())}async beginDownloadFlow(){const e=this._modelsByPath[this.currentModelPath],{abortController:t}=this.uiManager.showDownloadModal(e?.size);try{const e=await this.modelManager.getModel(e=>this.uiManager.updateLoadingProgress(e),t.signal);this.uiManager.hideDownloadModal(),this.uiManager.showInitializingOverlay(),await this.aiProvider.initSession(e),this.uiManager.hideInitializingOverlay(),this.uiManager.hideBoardBlocker(),this.uiManager.setCurrentModel(this.currentModelPath),await this.startGame()}catch(e){this.uiManager.hideDownloadModal(),"AbortError"===e.name?(await this.uiManager.showMustDownloadOverlay(),await this.beginDownloadFlow()):console.error("Model download failed:",e)}}async loadModelByPath(e){this.currentModelPath=e,this.modelManager=new ModelManager(e);const t=this._modelsByPath[e],{abortController:n}=this.uiManager.showDownloadModal(t?.size);try{const t=await this.modelManager.getModel(e=>this.uiManager.updateLoadingProgress(e),n.signal);this.uiManager.hideDownloadModal(),this.uiManager.showInitializingOverlay(),await this.aiProvider.initSession(t),this.uiManager.hideInitializingOverlay(),this.uiManager.hideBoardBlocker(),this.uiManager.setCurrentModel(e),this.gameInProgress||await this.startGame()}catch(e){this.uiManager.hideDownloadModal(),"AbortError"!==e.name&&console.error("Model download failed:",e)}}async startNewGame(e){if(this.isHumanWhite=e,!this.isHumanWhite&&this.board)this.board.flip();else if(this.isHumanWhite&&this.board){"black"===(this.board.getOrientation?this.board.getOrientation():"white")&&this.board.flip()}await this.aiProvider.reset(),this.board.clear(),this.board.start(),this.game.reset(),this.moveHistory=[],this.currentPositionIndex=-1,this.uiManager.hideGameOverlay(),this.uiManager.clearMoveArrows(),this.uiManager.clearLastMoveHighlight(),this.updateStatus(),this.updateMoveHistory(),await this.startGame()}async startGame(){this.gameInProgress=!0,this.currentPositionIndex=-1,this.isHumanWhite||await this.getAIMove()}async getAIMove(){if(this.gameInProgress&&!this.game.game_over()){if(!this.aiProvider.isReady)return console.error("AI provider not ready"),void this.uiManager.updateStatus("Error: AI provider not initialized");try{const e=await this.aiProvider.getMove(this.moveHistory.map(e=>e.from+e.to));if(e){const{uciMove:t,topMoves:n}=e;this.showProbabilities&&n&&n.length>0&&(this.uiManager.showMoveArrows(n),await new Promise(e=>setTimeout(e,2e3)),this.uiManager.clearMoveArrows()),this.playMove(t,n)}else console.error("AI returned null move"),this.uiManager.updateStatus("Error: AI returned no move")}catch(e){console.error("Error getting AI move:",e),this.uiManager.updateStatus("Error getting AI move: "+e.message)}}}playMove(e,t){const n=this.game.move(e,{sloppy:!0});return n?(t&&(n.topMoves=t),this.moveHistory.push(n),this.currentPositionIndex=this.moveHistory.length-1,this.uiManager.highlightLastMove(n.from,n.to),this.board.fen(this.game.fen(),()=>{this.updateStatus(),this.updateMoveHistory()}),n):null}isAtPresentPosition(){return-1===this.currentPositionIndex||this.currentPositionIndex===this.moveHistory.length-1}onDragStart(e){if(!this.isAtPresentPosition())return!1;const t=e=>/^w/.test(e),n=e=>/^b/.test(e);if("white"===e.orientation&&!t(e.piece))return!1;if("black"===e.orientation&&!n(e.piece))return!1;if(this.game.game_over())return!1;if("w"===this.game.turn()&&!t(e.piece))return!1;if("b"===this.game.turn()&&!n(e.piece))return!1;return this.game.moves({square:e.square,verbose:!0}).forEach(e=>{this.uiManager.addCircle(e.to)}),!0}onDrop(e){let t={from:e.source,to:e.target,promotion:"q"};const n=this.game.move(t,{sloppy:!0});if(!n)return this.uiManager.clearCircles(),"snapback";if(n.flags.includes("p"))return this.game.undo(),this.uiManager.clearCircles(),this.uiManager.showPromotionDialog(n.to,n.color).then(e=>{if(!e)return void this.board.fen(this.game.fen());t.promotion=e;const n=this.playMove(t);n&&this.aiProvider.opponentMove(n.from+n.to).then(()=>{this.getAIMove()}).catch(e=>{console.error("Error in post-move sequence:",e)})}).catch(e=>{console.error("Error in promotion dialog:",e)}),!0;{this.game.undo();const e=this.playMove(t);return this.uiManager.clearCircles(),e?(this.aiProvider.opponentMove(e.from+e.to).then(()=>{this.getAIMove()}).catch(e=>{console.error("Error in post-move sequence:",e)}),!0):"snapback"}}updateStatus(){let e="";const t="w"===this.game.turn()?"White":"Black";if(this.game.game_over())this.game.in_checkmate()&&"w"===this.game.turn()?(e="Game over: white is in checkmate. Black wins!",this.gameInProgress=!1,this.uiManager.showGameOverlay("Checkmate! Black wins!")):this.game.in_checkmate()&&"b"===this.game.turn()?(e="Game over: black is in checkmate. White wins!",this.gameInProgress=!1,this.uiManager.showGameOverlay("Checkmate! White wins!")):this.game.in_stalemate()&&"w"===this.game.turn()?(e="Game is drawn. White is stalemated.",this.gameInProgress=!1,this.uiManager.showGameOverlay("Draw: Stalemate!")):this.game.in_stalemate()&&"b"===this.game.turn()?(e="Game is drawn. Black is stalemated.",this.gameInProgress=!1,this.uiManager.showGameOverlay("Draw: Stalemate!")):this.game.in_threefold_repetition()?(e="Game is drawn by threefold repetition rule.",this.gameInProgress=!1,this.uiManager.showGameOverlay("Draw: Threefold Repetition!")):this.game.insufficient_material()?(e="Game is drawn by insufficient material.",this.gameInProgress=!1,this.uiManager.showGameOverlay("Draw: Insufficient Material!")):this.game.in_draw()&&(e="Game is drawn by fifty-move rule.",this.gameInProgress=!1,this.uiManager.showGameOverlay("Draw: Fifty-move Rule!"));else{if(this.game.in_check()){e=t+" is in check! ";const n=this.findKingSquare(this.game.turn());this.uiManager.showCheck(n)}e=e+t+" to move."}this.uiManager.updateStatus(e)}updateMoveHistory(){const e=new Chess,t=[];for(const n of this.moveHistory){const o=e.move({from:n.from,to:n.to,promotion:n.promotion},{sloppy:!1});o&&t.push(o)}this.uiManager.updateMoveHistory(t,this.currentPositionIndex)}findKingSquare(e){const t=this.game.board();for(let n=0;n<8;n++)for(let o=0;o<8;o++)if(t[n]&&t[n][o]&&"k"===t[n][o].type&&t[n][o].color===e){return String.fromCharCode(97+o)+String(8-n)}return null}navigateToMove(e){const t=new Chess;for(let n=0;n<=e&&n<this.moveHistory.length;n++){const e=this.moveHistory[n];t.move({from:e.from,to:e.to,promotion:e.promotion},{sloppy:!1})}if(this.game.load(t.fen()),this.currentPositionIndex=e,this.uiManager.clearMoveArrows(),this.showProbabilities&&e>=0&&e<this.moveHistory.length){const t=this.moveHistory[e];t.topMoves&&t.topMoves.length>0&&this.uiManager.showMoveArrows(t.topMoves)}this.board.fen(this.game.fen(),()=>{this.updateStatus(),this.updateMoveHistory()})}}